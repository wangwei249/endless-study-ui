var Podium=pc.createScript("podium");Podium.prototype.initialize=function(){var t=this.app;this.player=t.root.findByName("Player"),this.player.script.player.on("jump",this.onPlayerJump,this),this.game=t.root.findByName("Root"),this.game.script.game.on("reset",this.onReset,this),this.model=this.entity.findByName("Model"),this.color=new pc.Color,this.start=this.entity.getPosition().clone()},Podium.prototype.update=function(t){this.tweening&&this.entity.translate(-10*t,0,0)},Podium.prototype.onPlayerJump=function(){this.tweening=!0},Podium.prototype.onReset=function(){this.tweening=!1,this.entity.setPosition(this.start)};var Row=pc.createScript("row"),MIN=-5,MAX=5;Row.prototype.initialize=function(){var t=this.app;this.game=t.root.findByName("Root"),this.game.script.game.on("reset",this.onReset,this),this.children=this.entity.children,this.tweening=!1,this.start=this.entity.getPosition().clone()},Row.prototype.update=function(t){this.tweening&&this.entity.translate(-10*t,0,0)},Row.prototype.animate=function(){this.tweening=!0},Row.prototype.reset=function(t){var i=4*t;this.entity.setPosition(0,0,i)},Row.prototype.onReset=function(){this.entity.setPosition(this.start),this.tweening=!1};var PlatformMaterial=pc.createScript("platformMaterial");PlatformMaterial.prototype.initialize=function(){setTimeout(function(){this.setRandomMaterial()}.bind(this),0),this.model=null,this.white=this.app.assets.find("White","material").resource},PlatformMaterial.prototype.update=function(t){this.flashing>0&&(this.flashing-=t,this.flashing<0&&(this.model.model.meshInstances[0].material=this.material))},PlatformMaterial.prototype.setRandomMaterial=function(){if(this.model=this.entity.findByName("Model"),this.model){var t=this.app,a=[t.assets.find("Cyan","material"),t.assets.find("Purple","material"),t.assets.find("Blue","material"),t.assets.find("Pink","material")],i=Math.floor(pc.math.random(0,4));this.material=a[i].resource,this.model.model.meshInstances[0].material=this.material}},PlatformMaterial.prototype.flash=function(){this.model.model.meshInstances[0].material=this.white,this.flashing=.1};var Restart=pc.createScript("restart");function drawCircle(t,e,a,s){t.beginPath(),t.arc(e,a,s,0,2*Math.PI),t.stroke(),t.fill()}function drawTriangle(t,e,a,s){var n=new Path2D,i=0,r=s;n.moveTo(e+r*Math.cos(i),a+r*Math.sin(i)),i=120*Math.PI/180,n.lineTo(e+r*Math.cos(i),a+r*Math.sin(i)),i=240*Math.PI/180,n.lineTo(e+r*Math.cos(i),a+r*Math.sin(i)),i=360*Math.PI/180,n.lineTo(e+r*Math.cos(i),a+r*Math.sin(i)),t.fill(n)}Restart.attributes.add("playButton",{type:"asset",assetType:"texture"}),Restart.attributes.add("appStoreButton",{type:"asset",assetType:"texture"}),Restart.prototype.initialize=function(){var t=this.app;this.game=t.root.findByName("Root"),this.entity.script.htmlHandler.on("template",this.onTemplate,this)},Restart.prototype.onTemplate=function(t){var e=document.getElementById("c");if(e){var a=e.getContext("2d");a.strokeStyle="#ffffff",a.lineWidth=2,a.fillStyle="#222",drawCircle(a,50,50,48),a.fillStyle="#ffffff",drawTriangle(a,50,50,12)}this.score=document.querySelector(".restart-score"),this.setScore(this.game.script.game.score);var s=document.getElementById("app-store-button");s&&(s.src=this.appStoreButton.getFileUrl(),s.addEventListener("click",(function(){window.snapchatCta?snapchatCta():window.open("https://playcanvas.com")})));var n=document.getElementById("restart-button");n&&(n.src=this.playButton.getFileUrl(),n.addEventListener("mousedown",(function(t){n.classList.add("active")}),!0),n.addEventListener("mouseup",function(t){n.classList.remove("active"),this.game.script.game.start(),this.entity.enabled=!1}.bind(this),!0),n.addEventListener("touchstart",(function(t){n.classList.add("active"),t.preventDefault()}),!0),n.addEventListener("touchend",function(t){n.classList.remove("active"),this.game.script.game.start(),this.entity.enabled=!1,t.preventDefault()}.bind(this),!0));var i=document.querySelector(".restart");i&&i.classList.add("animate")},Restart.prototype.setScore=function(t){this.score&&(this.score.textContent=t)},Restart.prototype.onEnable=function(){var t=document.querySelector(".button");t&&t.classList.add("button-animate")};var Player=pc.createScript("player");Player.attributes.add("gravity",{type:"number",default:-30}),Player.attributes.add("jumpTime",{type:"number",default:.7});var tmp=new pc.Vec3,GAP=4,TUMBLE_SPEED=180,_rows=null;Player.prototype.initialize=function(){var t=this.app;this.vel=new pc.Vec3,this.acc=new pc.Vec3(0,this.gravity,0),this.start=this.entity.getPosition().clone(),this.rows=t.root.findByName("Rows"),this.game=t.root.findByName("Root"),this.game.script.game.on("reset",this.onReset,this),this.acc=new pc.Vec3(0,this.gravity,0),this.current=null,this.angVel=0,this.falling=!1,this.jumping=!1,this.jump=!1,this.recycling=!1,t.mouse.on("mousedown",(function(){"playing"===this.game.script.game.state&&(this.jumping||this.falling||(this.jump=!0))}),this),t.touch&&(t.touch=new pc.TouchDevice(window),t.touch.on("touchstart",(function(){"playing"===this.game.script.game.state&&(this.jumping||this.falling||(this.jump=!0))}),this)),_rows=this.rows.script.rows},Player.prototype.update=function(t){var i;if(!this.freeze){if(!this.falling&&!this.jumping&&this.jump){this.jump=!1,this.jumping=!0,this.current=null,this.angVel=0;var s=GAP/this.jumpTime,e=-.5*this.acc.y*this.jumpTime;this.vel.set(s,e,0),this.fire("jump")}if(this.falling)return tmp.copy(this.acc).scale(t),this.vel.add(tmp),tmp.copy(this.vel).scale(t),(i=this.entity.getPosition()).add(tmp),this.entity.rotate(this.angVel*t,0,0),void this.entity.setPosition(i);if(this.jumping){if(tmp.copy(this.acc).scale(t),this.vel.add(tmp),tmp.copy(this.vel).scale(t),(i=this.entity.getPosition()).add(tmp),i.x>35.5&&(i.x=36,this.freeze=!0,this.die()),i.y<this.start.y){this.jumping=!1,i.x=Math.round(i.x),i.y=this.start.y;var h=_rows.checkPlayer(i,this.entity.collision.halfExtents.z);if(h.platform){0===h.type?(h.platform.script.platformMaterial.flash(),h.platform.script.platform.dip(),this.current=h.platform,this.offsetZ=i.z-this.current.getPosition().z,this.game.script.game.addScore(1)):1===h.type?(h.platform.script.platform.dip(),this.falling=!0,this.vel.set(0,0,5),this.angVel=TUMBLE_SPEED,this.die()):2===h.type&&(h.platform.script.platform.dip(),this.falling=!0,this.vel.set(0,0,-5),this.angVel=-TUMBLE_SPEED,this.die());var r=(h.row-1)%8;h.row>=1&&(this.recycling=!0),this.recycling&&this.rows.script.rows.recycleRow(r)}else this.falling=!0,this.vel.x=0,this.die()}this.entity.setPosition(i)}else this.current&&((i=this.entity.getPosition()).y=this.current.getPosition().y+1.5,i.z=this.current.getPosition().z+this.offsetZ,this.entity.setPosition(i))}},Player.prototype.die=function(){this.fire("die"),this.game.script.game.gameover()},Player.prototype.onReset=function(){this.entity.setPosition(this.start),this.entity.setLocalEulerAngles(0,0,0),this.jumping=!1,this.vel.set(0,0,0),this.current=null,this.falling=!1,this.recycling=!1,this.freeze=!1};var Rows=pc.createScript("rows"),result={platform:null,type:0,row:-1};Rows.prototype.initialize=function(){var t=this.app;this.player=t.root.findByName("Player"),this.rows=this.entity.children,this.templates=t.root.findByName("Templates").children,t.fire("score:set",score),window.parent.postMessage({score:35},"*"),setTimeout(function(){this.fillRow(this.rows[0],-5),this.fillRow(this.rows[1],5),this.fillRow(this.rows[2],-5),this.fillRow(this.rows[3],5),this.fillRow(this.rows[4],-5),this.fillRow(this.rows[5],5),this.fillRow(this.rows[6],-5),this.fillRow(this.rows[7],5),this.fillRow(this.rows[8],-5)}.bind(this),0)},Rows.prototype.getPlatform=function(){var t=Math.floor(pc.math.random(0,this.templates.length));return this.templates[t].clone()},Rows.prototype.recycleRow=function(t){console.log("recycling: "+t),this.rows[t].script.row.animate()},Rows.prototype.fillRow=function(t,o){for(var s=pc.math.random(-18,-16),r=t.getPosition();s<20;){var l=this.getPlatform();t.addChild(l),l.setPosition(r.x,r.y,s),l.script.platform.setSpeed(o),s+=3+2*l.collision.halfExtents.z}},Rows.prototype.checkPlayer=function(t,o){var s,r,l=null,i=0,e=this.rows.length;for(i=0;i<e&&(r=i,s=(l=this.rows[i]).getPosition(),!(t.x>s.x-.1&&t.x<s.x+.1));i++)l=null;if(result.platform=null,l){var n=l.children;for(i=0,e=n.length,i=0;i<e;i++){s=n[i].getPosition(),platformHalfWidth=n[i].collision.halfExtents.z;var a=t.z-o,h=t.z+o,f=s.z-platformHalfWidth,p=s.z+platformHalfWidth;if(!(a>p||h<f))return t.z>p?(result.platform=n[i],result.type=1,result.row=r,result):t.z<f?(console.log(t.z,f),result.platform=n[i],result.type=2,result.row=r,result):(console.log(t.z,f),result.platform=n[i],result.type=0,result.row=r,result)}}return result};var Camera=pc.createScript("camera"),offset=new pc.Vec3;Camera.prototype.initialize=function(){var t=this.app;this.player=t.root.findByName("Player"),this.game=t.root.findByName("Root"),this.game.script.game.on("reset",this.onReset,this),this._start=this.entity.getPosition().clone(),this._offset=(new pc.Vec3).copy(this.player.getPosition()).sub(this._start),this.entity.camera.frustumCulling=!0},Camera.prototype.postUpdate=function(t){offset.copy(this.player.getPosition()).sub(this.entity.getPosition());var e=offset.x-this._offset.x;if(e>4){var i=10*(e-4)/4;i=Math.max(i,1),this.entity.translate(i*t,0,0)}},Camera.prototype.onReset=function(){this.entity.setPosition(this._start)};var CssHandler=pc.createScript("cssHandler");CssHandler.attributes.add("css",{type:"asset",assetType:"css"}),CssHandler.prototype.initialize=function(){this.element=document.createElement("style"),document.head.appendChild(this.element),this.asset=null,this.assetId=0},CssHandler.prototype.update=function(s){this.assetId!==this.css.id&&this.attachAsset(this.css.id,this.template)},CssHandler.prototype.attachAsset=function(s,t){if(this.assetId=s,!this.assetId)return t.call(this);var e=this.app.assets.get(this.assetId),a=this;e._onLoad=function(s){t.call(a,s,s.resource)},e.on("load",e._onLoad),t.call(this,e,e.resource),this.app.assets.load(e)},CssHandler.prototype.template=function(s,t){this.asset&&this.asset!==s&&this.asset.off("load",this.asset._onLoad),this.asset=s,this.element.innerHTML=t||""};var Game=pc.createScript("game");Game.prototype.initialize=function(){var e=this.app;this.score=0,this.state="menu",this.restart=e.root.findByName("Restart"),this.ingame=e.root.findByName("InGame"),this.resize(),window.addEventListener("resize",this.resize.bind(this),!1)},Game.prototype.resize=function(){},Game.prototype.addScore=function(e){this.score+=e,"playing"===this.state&&this.ingame.script.inGame.onTemplate()},Game.prototype.start=function(){this.reset(),this.state="playing",this.score=0,this.ingame.enabled=!0},Game.prototype.gameover=function(){this.state="menu",this.restart.enabled=!0,this.ingame.enabled=!1},Game.prototype.reset=function(){this.state="menu",this.fire("reset")};var HtmlHandler=pc.createScript("htmlHandler");HtmlHandler.attributes.add("html",{type:"asset",assetType:"html"}),HtmlHandler.prototype.initialize=function(){this.element=document.createElement("div"),this.element.classList.add("container"),document.body.appendChild(this.element),this.asset=null,this.assetId=0,this.counter=0,this.on("enable",(function(){this.asset&&(this.element.parentNode||document.body.appendChild(this.element),this.template(this.asset,this.asset.resource))})),this.on("disable",(function(){this.element.parentNode.removeChild(this.element)}))},HtmlHandler.prototype.update=function(t){this.assetId!==this.html.id&&this.attachAsset(this.html.id,this.template)},HtmlHandler.prototype.attachAsset=function(t,e){if(this.assetId=t,!this.assetId)return e.call(this);var s=this.app.assets.get(this.assetId),i=this;s._onLoad=function(t){e.call(i,t,t.resource)},s.on("load",s._onLoad),e.call(this,s,s.resource),this.app.assets.load(s)},HtmlHandler.prototype.template=function(t,e){this.asset&&this.asset!==t&&this.asset.off("load",this.asset._onLoad),this.asset=t,this.element.innerHTML=e||"",e&&this.bindEvents(),this.fire("template",this.element)},HtmlHandler.prototype.bindEvents=function(){};var InGame=pc.createScript("inGame");InGame.prototype.initialize=function(){this.game=this.app.root.findByName("Root"),this.entity.script.htmlHandler.on("template",this.onTemplate,this)},InGame.prototype.onTemplate=function(t){var e=document.querySelector(".ingame-score");e&&(e.textContent=this.game.script.game.score)};var Platform=pc.createScript("platform"),MIN=-20,MAX=20;Platform.prototype.initialize=function(){var t=this.app;this.setSpeed(5),this.player=t.root.findByName("Player"),this.player.script.player.on("die",this.onPlayerDie,this),this.game=t.root.findByName("Root"),this.game.script.game.on("reset",this.onReset,this)},Platform.prototype.update=function(t){var e=this.entity.getLocalPosition();e.z+=this.speed*t,e.z<MIN&&this.speed<0&&(e.z=pc.math.clamp(-e.z,MIN,MAX)),e.z>MAX&&this.speed>0&&(e.z=pc.math.clamp(-e.z,MIN,MAX)),e.y<0&&(e.y+=.9*t,e.y>0&&(e.y=0)),this.entity.setLocalPosition(e)},Platform.prototype.setSpeed=function(t){this.speed=t,this._oldSpeed=this.speed},Platform.prototype.dip=function(){this.dipping=.1;var t=this.entity.getLocalPosition();t.y-=.3,this.entity.setLocalPosition(t)},Platform.prototype.onReset=function(){this.speed=this._oldSpeed},Platform.prototype.onPlayerDie=function(){0!==this.speed&&(this._oldSpeed=this.speed,this.speed=0)};window.setScore=function(e){pc.Application.getApplication();alert("window.setScore:"+e)};var ScoreKeeper=pc.createScript("scoreKeeper");ScoreKeeper.prototype.initialize=function(e){alert("ScoreKeeper.initialize"),this.app.on("score:set",(function(e){alert("调用playcanvas"),this.setScore(e)}),this)},ScoreKeeper.prototype.setScore=function(e){alert("ScoreKeeper.score = "+e)};

//# sourceMappingURL=__game-scripts.js.map